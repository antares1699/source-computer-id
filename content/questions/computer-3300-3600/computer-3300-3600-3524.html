{"title":"Terowongan transparan antara antarmuka pada host jarak jauh","draft":false,"url":"/terowongan-transparan-antara-antarmuka-pada-host-jarak-jauh-yd5mxxeg","votes":"4","answers_count":"2","categories":["Komputer"],"tags":["linux","networking","vpn","iptables","tunnel"],"snippet":"Saya perlu membuat solusi yang akan berfungsi sebagai sakelar jaringan dengan dua port: satu port terletak di satu negara dan port kedua di negara lain.                +------------ Virtual switch ----------------++---------+   |   +-------+...","body":"<p> Saya perlu membuat solusi yang akan berfungsi sebagai sakelar jaringan dengan dua port: satu port terletak di satu negara dan port kedua di negara lain. </p> <pre><code>              +------------ Virtual switch ----------------+\n+---------+   |   +-------+    +----------+    +-------+   |   +--------+\n|Client A |&lt;--+--&gt;| BOX 1 |&lt;--&gt;|VPN server|&lt;--&gt;| BOX 2 |&lt;--+--&gt;|Client B|\n+---------+   |   +-------+    +----------+    +-------+   |   +--------+\n              +--------------------------------------------+\n</code></pre> <p> Klien A dan Klien B harus merasakannya seperti saklar layer 2 biasa. Koneksi VPN antara dua kotak adalah OpenVPN.\nJadi saya perlu meneruskan frame Ethernet entah bagaimana melalui terowongan VPN di antara dua kotak. Kotak 1 dan 2 menjalankan Debian jessie. Saya harap tidak menulis perangkat lunak saya sendiri untuk itu :)\nAdakah yang bisa menyarankan solusi yang mungkin? </p>\n\n<p> P.S. Diperlukan untuk menghubungkan dua perangkat keras yang dirancang untuk bekerja <strong> hanya </strong> di LAN. </p>\n\n<p><strong> UPD: </strong> Saya telah menginstal 4 VM untuk mensimulasikan pengaturan seperti itu (vpnserver dihilangkan): <br> - Semua mesin adalah kotak debian <br> - Kotak 1 dan Kotak 2 memiliki terowongan keran GRE di antara keduanya (Ethernet melalui IP) <br> - Pada Klien Antarmuka lokal yang dijembatani dengan antarmuka gretap: bridge memiliki alamat 10.0.0.253 <br> - Pada antarmuka lokal Klien B yang dijembatani dengan antarmuka gretap: bridge memiliki alamat 10.0.0.254 <br> - Klien A memiliki IP statis 192.168.1.1 <br> - Klien B memiliki IP statis 192.168.1.2 </p>\n\n<p> Dari Klien A saya mengirim permintaan ICMP Echo ke 192.168.1.2 dan saya dapat melihat permintaan ARP <em> &quot;Siapa yang memiliki 192.168.1.2, beri tahu 192.168.1.1&quot; </em> di jembatan di Kotak 1, di jembatan di Kotak 2 dan di Klien B. <strong> Tapi </strong> Respons ARP hanya terlihat pada Klien B. Jadi respons ARP tidak akan kembali ke Box2.\nDan semua jaringan antara 10.0.0.253 dan 10.0.0.254 berfungsi dengan baik. Jadi, saya kira masalah itu disebabkan oleh menjembatani. </p>\n\n<p><strong> UPD2: </strong> Sekarang saya menghapus terowongan keran GRE dan membuat jaringan reguler antara Kotak 1 dan Kotak 2. Ketika saya membuat jembatan, ping mulai berfungsi. Apa yang bisa menyebabkan masalah saat melakukan terowongan GRE? </p>\n\n<p><strong> Larutan: </strong> Saya akhirnya mengonfigurasi semuanya di VM dengan GRE-TAP. Saya telah menggunakan terowongan GRE-TAP melalui jaringan biasa antara Kotak 1 dan Kotak 2. Dan kemudian saya menjembatani antarmuka tunneling dengan antarmuka lokal di setiap Kotak. Di bawah ini adalah langkah-langkah saya: </p>\n\n<p><strong> Kotak 1 </strong></p> <pre><code>ip link add tunnel0 type gretap remote 192.168.0.2 local 192.168.0.1\nbrctl addbr br0\nbrctl addif br0 eth2  # eth2 - is a local interface on Box 1\nbrctl addif br0 tunnel\nip addr add 10.0.0.253 dev tunnel0\nip link set br0 up\nip link set tunnel0 up\n</code></pre> <p><strong> Kotak 2 </strong></p> <pre><code>ip link add tunnel0 type gretap remote 192.168.0.1 local 192.168.0.2\nbrctl addbr br0\nbrctl addif br0 eth2  # eth2 - is a local interface on Box 2\nbrctl addif br0 tunnel\nip addr add 10.0.0.254 dev tunnel0\nip link set br0 up\nip link set tunnel0 up\n</code></pre> <p><strong> Terimakasih untuk semua! </strong></p>","source":"https://superuser.com/questions/1185070/transparent-tunnel-between-interfaces-on-remote-hosts","author":"<a href=\"https://superuser.com/users/703863/victor-crimea\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">victor_crimea</span></a>","replies":[{"reply":"Ini akan sangat sepele jika Anda dapat memiliki kedua tautan klien <b> langsung </b> ke server OpenVPN. Bisakah kamu melakukan itu? Juga: apakah OpenVPN dirutekan atau dijembatani? Apakah Anda mengontrol server OpenVPN?","author":"<a href=\"https://superuser.com/users/255732/mariusmatutiae\" target=\"_blank\" rel=\"nofollow noopener\">MariusMatutiae</a>"},{"reply":"Iya. Saya memiliki kendali atas Boxes dan server OpenVPN, namun saya tidak dapat mengonfigurasi Klien, itulah mengapa saya tidak dapat menghubungkannya ke jaringan VPN.","author":"<a href=\"https://superuser.com/users/703863/victor-crimea\" target=\"_blank\" rel=\"nofollow noopener\">victor_crimea</a>"},{"reply":"Openvpn dirutekan atau dijembatani? Apakah Anda menggunakan file <i> tong besar </i> atau a <i> keran </i> antarmuka?","author":"<a href=\"https://superuser.com/users/255732/mariusmatutiae\" target=\"_blank\" rel=\"nofollow noopener\">MariusMatutiae</a>"},{"reply":"Saya menggunakan vtund untuk membuat sirkuit Ethernet virtual","author":"<a href=\"https://superuser.com/users/69290/majenko\" target=\"_blank\" rel=\"nofollow noopener\">Majenko</a>"},{"reply":"Saya menggunakan antarmuka tun untuk OpenVPN, karena awalnya diinstal bukan untuk tujuan khusus ini. Jadi saya tidak dapat dengan mudah mengubah OpenVPN untuk menggunakan antarmuka ketuk.","author":"<a href=\"https://superuser.com/users/703863/victor-crimea\" target=\"_blank\" rel=\"nofollow noopener\">victor_crimea</a>"}],"answers":[{"answer":"<p> Saya belum mencobanya sendiri, tetapi saya tahu Anda dapat menggunakan <code>gretap</code> ke lapisan terowongan 2 (ethernet) di atas lapisan 3 (ip). Menurut mis. untuk ini <a href=\"http://blog.asiantuntijakaveri.fi/2012/01/layer-2-over-layer-3-using-linux-built.html\" rel=\"nofollow noopener\" target=\"_blank\"> catatan blog </a> , Anda menyiapkan satu antarmuka <code>gretap</code> di setiap ujung dan menjembataninya dengan antarmuka ethernet Anda. Jika saya memahami semuanya dengan benar, dalam contoh <code>172.31.0.1</code> harus menjadi alamat titik akhir VPN di Kotak 1, dan <code>172.31.0.2</code> alamat titik akhir VPN di Kotak 2. <code>10.10.10.1</code> adalah alamat LAN lokal untuk Kotak 1, dan <code>10.10.10.2</code> alamat LAN untuk Kotak 2. </p>\n\n<p> Kotak 1: </p> <pre><code>ip link add gretap0 type gretap local 172.31.0.1 remote 172.31.0.2\nip link set dev gretap0 up\nip link set dev eth0 up\nbrctl addbr br0\nbrctl addif br0 gretap0\nbrctl addif br0 eth0\nip addr add 10.10.10.1/24 dev br0\nip link set br0 up\n</code></pre> <p> Kotak 2: </p> <pre><code>ip link add gretap0 type gretap local 172.31.0.2 remote 172.31.0.1\nip link set dev gretap0 up\nip link set dev eth0 up\nbrctl addbr br0\nbrctl addif br0 gretap0\nbrctl addif br0 eth0\nip addr add 10.10.10.2/24 dev br0\nip link set br0 up\n</code></pre> <p> Anda mungkin perlu mengubah pengaturan MTU. Saya tidak dapat menguji pengaturan ini, jadi Anda mungkin juga perlu mengubah hal-hal lain. </p>\n\n<p><strong> Sunting </strong> : <a href=\"http://backreference.org/2013/07/23/gre-bridging-ipsec-and-nfqueue/\" rel=\"nofollow noopener\" target=\"_blank\"> Sini </a> adalah artikel yang menjelaskan masalah MTU, tampaknya sedikit terlibat. Mungkin lebih mudah dalam kasus Anda jika Anda dapat mengontrol pengaturan VPN MTU. </p>","votes":"5","source":"https://superuser.com/a/1185077","author":"<a href=\"https://superuser.com/users/327880/dirkt\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">dirkt</span></a>","replies":[{"reply":"Saya ingin menghindari alamat Ip di Box di sisi lokal. Bisakah saya melakukannya dengan gretap?","author":"<a href=\"https://superuser.com/users/703863/victor-crimea\" target=\"_blank\" rel=\"nofollow noopener\">victor_crimea</a>"},{"reply":"Hanya saja, jangan menetapkan alamat IP ke bridge jika Anda tidak membutuhkan / menginginkannya.","author":"<a href=\"https://superuser.com/users/327880/dirkt\" target=\"_blank\" rel=\"nofollow noopener\">dirkt</a>"},{"reply":"Saya telah mensimulasikan penyiapan yang disarankan di VM dan ada masalah dengan aliran paket. Saya telah menambahkan penjelasan untuk pertanyaan.","author":"<a href=\"https://superuser.com/users/703863/victor-crimea\" target=\"_blank\" rel=\"nofollow noopener\">victor_crimea</a>"},{"reply":"BTW, menggunakan antarmuka <code>tap</code> untuk OpenVPN seperti yang disebutkan dalam jawaban lain akan menjadi solusi yang lebih baik, jika keadaan memungkinkan, karena ini menghindari satu lapisan enkapsulasi tambahan.","author":"<a href=\"https://superuser.com/users/327880/dirkt\" target=\"_blank\" rel=\"nofollow noopener\">dirkt</a>"},{"reply":"Saya sangat setuju dengan anda. Menggunakan keran akan menyebabkan overhead yang lebih rendah untuk kasus seperti itu.","author":"<a href=\"https://superuser.com/users/703863/victor-crimea\" target=\"_blank\" rel=\"nofollow noopener\">victor_crimea</a>"}]},{"answer":"<p> Ini tidak terlalu sulit, karena yang Anda minta hanyalah agar semua lalu lintas L2 dapat melewati dari satu jaringan ke jaringan lainnya, yang merupakan fitur standar dari a <a href=\"https://openvpn.net/index.php/open-source/documentation/miscellaneous/76-ethernet-bridging.html\" rel=\"nofollow noopener\" target=\"_blank\"> menjembatani OpenVPN </a> koneksi. Artinya: </p>\n\n<ol>\n<li><p> baik Anda mengkonfigurasi server OpenVPN (dan dua klien) untuk mengatur koneksi OpenVPN yang dijembatani (dan ingat untuk mengizinkan koneksi dari klien ke klien lain melalui <em> klien-ke-klien </em> instruksi dalam file konfigurasi server), ... </p></li>\n<li><p> atau Anda menyingkirkan perantara, dan langsung menghubungkan Box1 dan Box2, seperti yang dibahas misalnya <a href=\"https://docs.openvpn.net/how-to-tutorialsguides/virtual-platforms/site-to-site-layer-2-bridging-using-openvpn-access-server/\" rel=\"nofollow noopener\" target=\"_blank\"> sini </a> atau <a href=\"https://www.dd-wrt.com/wiki/index.php/OpenVPN_-_Site-to-Site_Bridged_VPN_Between_Two_Routers\" rel=\"nofollow noopener\" target=\"_blank\"> sini </a> . </p></li>\n</ol>\n\n<p> Di <strong> antara </strong> kasus, Anda perlu bekerja pada DHCP dan merutekan masuk <em> kedua </em> LAN, karena keduanya <strong> harus </strong> milik domain siaran yang sama. Misalnya, kami dapat memutuskan bahwa subnet yang kami gunakan adalah <em> 192.168.0.0/23 </em> , dengan server DHCP di LAN1 yang membagikan alamat dalam jangkauan <em> 192.168.0.0/24 </em> , dan server DHCP di LAN2 yang membagikan alamat dalam jangkauan <em> 192.168.1.0/24 </em> . </p>\n\n<p> Kemudian Anda perlu menyesuaikan rute. Misalkan Box1 adalah pc di LAN1 dengan alamat 192.168.0.121, dan Box2 adalah pc di LAN2 dengan alamat IP 192.168.1.173. Kemudian di gateway LAN1 Anda perlu menambahkan rute: </p> <pre><code>ip route add 192.168.1.0/24 via 192.168.0.121 \n</code></pre> <p> sementara di gateway LAN2 Anda perlu menambahkan: </p> <pre><code>ip route add 192.168.0.0/24 via 192.168.1.173\n</code></pre> <p> Ini menghasilkan sejumlah lalu lintas L2 intra-situs, yang mungkin mengganggu Anda. Saya memiliki konfigurasi tiga situs seperti ini, dan saya tidak memiliki masalah dengan jumlah lalu lintas, dan koneksi 100Mb / s, tetapi YMMV. Jika Anda ingin membatasi jumlah lalu lintas L2 yang melintasi OpenVPN, Anda dapat menggunakan <em> ebtables </em> di Box1 dan Box2. </p>\n\n<p> Itulah satu-satunya cara yang saya tahu untuk menyadari apa yang Anda minta. </p>","votes":"1","source":"https://superuser.com/a/1185135","author":"<a href=\"https://superuser.com/users/255732/mariusmatutiae\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">MariusMatutiae</span></a>","replies":[]}]}
