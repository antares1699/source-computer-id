{"title":"tar / bz2 memampatkan file yang menghapus file asli yang tidak dikompresi","draft":false,"url":"/tar-bz2-memampatkan-file-yang-menghapus-file-asli-yang-tidak-dikompresi-siw7a5cl","votes":"4","answers_count":"1","categories":["Komputer"],"tags":["linux","compression","tar","bzip2"],"snippet":"Apakah ada cara untuk mengubah direktori bernama dir1 menjadi dir1.tar.bz2 tanpa menyimpan aslinya? Saya perlu menghemat ruang dan ingin mengompres beberapa file besar tetapi tidak memiliki cukup ruang untuk menyimpan salinan terkompresi...","body":"<p> Apakah ada cara untuk mengubah direktori bernama dir1 menjadi dir1.tar.bz2 tanpa menyimpan aslinya? Saya perlu menghemat ruang dan ingin mengompres beberapa file besar tetapi tidak memiliki cukup ruang untuk menyimpan salinan terkompresi dan aslinya. Apakah ada cara untuk mengubah file yang ada menjadi arsip secara langsung? </p>","source":"https://superuser.com/questions/656111/tar-bz2-compress-a-file-removing-uncompressed-original","author":"<a href=\"https://superuser.com/users/225838/gregg-leventhal\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">Gregg Leventhal</span></a>","replies":[],"answers":[{"answer":"<p> <code>tar</code> tidak dapat melakukannya, tetapi Anda dapat mencapai apa yang Anda inginkan dengan: </p>\n\n<p> <code>find dir1 -depth -print0 | xargs -0 tar --create --no-recursion --remove-file --file - | bzip2 &gt; dir1.tar.bz2</code> </p>\n\n<p> dimana: </p>\n\n<ul>\n<li><p> <code>find dir1 -depth -print0</code> </p>\n\n<p> daftar semua file dan direktori di <code>dir1</code>, daftar isi direktori sebelum direktori itu sendiri (<code>-depth</code>). Penggunaan <code>-print0</code> (dan <code>-0</code> pada <code>xargs</code> di bawah) adalah kuncinya <strong> mendukung direktori dan nama file dengan spasi yang disematkan </strong> . </p></li>\n<li><p> <code>xargs -0 tar --create --no-recursion --remove-file --file -</code> </p>\n\n<p> membuat arsip tar dan menambahkan setiap file atau direktori ke dalamnya. Arsip tar dikirim ke output standar dengan opsi <code>--file -</code>. </p></li>\n<li><p> <code>bzip2 &gt; dir1.tar.bz2</code> </p>\n\n<p> mengompresi arsip tar dari input standar ke file bernama <code>dir1.tar.bz2</code>. </p></li>\n</ul>\n\n<p><strong> Jumlah ruang disk kosong yang dibutuhkan adalah ukuran file terkompresi terbesar di tahun <code>dir1</code> </strong> karena <code>tar</code>, saat memproses file, menunggu hingga pengarsipan selesai sebelum menghapusnya. Karena <code>tar</code> disalurkan ke <code>bzip2</code>, untuk sesaat, sebelum <code>tar</code> menghapusnya, setiap file berada di dua tempat: tidak dikompresi di sistem file dan dikompresi di dalam <code>dir1.tar.bz2</code>. </p>\n\n<p> Saya ingin tahu bagaimana ruang disk digunakan, jadi saya membuat eksperimen ini di VM Ubuntu saya: </p>\n\n<ol>\n<li><p> Buat sistem file 1 GB: </p> <pre><code>$ dd if=/dev/zero of=/tmp/1gb bs=1M count=1024\n$ losetup /dev/loop0 /tmp/1gb\n$ mkfs.ext3 /dev/loop0\n$ sudo mount /dev/loop0 /tmp/mnt\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/loop0     1008M   34M  924M   4% /tmp/mnt\n</code></pre> </li>\n<li><p> Isi filesystem dengan 900 file berukuran 1 megabyte: </p> <pre><code>$ chown jaume /tmp/mnt\n$ mkdir /tmp/mnt/dir1\n$ for (( i=0; i&lt;900; i++ )); do dd if=/dev/urandom of=/tmp/mnt/dir1/file$i bs=1M count=1; done\n$ chown -R jaume /tmp/mnt\n$ df -h\nFilesystem      Size  Used Avail Use% Mounted on\n/dev/loop0     1008M  937M   20M  98% /tmp/mnt\n</code></pre> <p> Sistem berkas sekarang 98% penuh. </p></li>\n<li><p> Buat salinan <code>dir1</code> untuk verifikasi nanti: </p> <pre><code>$ cp -a /tmp/mnt/dir1 /tmp/dir1-check\n</code></pre> </li>\n<li><p> Kompres <code>--file -</code>: </p> <pre><code>$ ls /tmp/mnt\ndir1  lost+found\n$ find /tmp/mnt/dir1 -depth -print0 | xargs -0 tar --create --no-recursion --remove-file --file - | bzip2 &gt; /tmp/mnt/dir1.tar.bz2\n$\n</code></pre> <p><strong> Perhatikan bahwa perintah berjalan tanpa kesalahan &#39;tidak ada ruang tersisa di perangkat&#39;. </strong> </p>\n\n<p> <code>dir1</code> telah dihapus, hanya <code>dir1.tar.bz2</code> yang ada: </p> <pre><code>$ ls /tmp/mnt\ndir1.tar.bz2  lost+found\n</code></pre> </li>\n<li><p> Perluas <code>dir1.tar.bz2</code> dan bandingkan dengan <code>/tmp/dir1-check</code>: </p> <pre><code>$ tar --extract --file dir1.tar.bz2 --bzip2 --directory /tmp\n$ diff -s /tmp/dir1 /tmp/dir1-check\n(...)\nFiles /tmp/dir1/file97 and /tmp/dir1-check/file97 are identical\nFiles /tmp/dir1/file98 and /tmp/dir1-check/file98 are identical\nFiles /tmp/dir1/file99 and /tmp/dir1-check/file99 are identical\n$\n</code></pre> <p> Salinan <code>dir1</code> dan <code>dir1.tar.bz2</code> yang tidak terkompresi adalah sama! </p></li>\n</ol>\n\n<p> Ini dapat digeneralisasikan dalam skrip: </p>\n\n<ol>\n<li><p> Buat file bernama <code>tarrm</code> (atau nama lain yang Anda sukai) dengan konten berikut: </p> <pre><code>#!/bin/bash\n\n# This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.\n# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.\n# You should have received a copy of the GNU General Public License along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.\n\n# dir is first argument\ndir=\"$1\"\n# check dir exists\nif [ ! -d \"$dir\" ]; then\n    echo \"$(basename $0): error: '$dir' doesn't exist\" 1&gt;&amp;2\n    exit 1\nfi\n# check if tar file exists\nif [ -f \"${dir}.tar\" -o -f \"${dir}.tar.bz2\" ]; then\n    echo \"$(basename $0): error: '$dir.tar' or '${dir}.tar.bz2' already exist\" 1&gt;&amp;2\n    exit 1\nfi\n\n# --keep is second argument\nif [ \"X$2\" == \"X--keep\" ]; then\n    # keep mode\n    removefile=\"\"\n    echo \" Tarring '$dir'\"\nelse\n    removefile=\"--remove-file\"\n    echo \" Tarring and **deleting** '$dir'\"\nfi\n\n# normalize directory name (for example, /home/jaume//// is a legal directory name, but will break ${dir}.tar.bz2 - it needs to be converted to /home/jaume)\ndir=$(dirname \"$dir\")/$(basename \"$dir\")\n\n# create compressed tar archive and delete files after adding them to it\nfind \"$dir\" -depth -print0 | xargs -0 tar --create --no-recursion $removefile --file - | bzip2 &gt; \"${dir}.tar.bz2\"\n\n# return status of last executed command\nif [ $? -ne 0 ]; then\n    echo \"$(basename $0): error while creating '${dir}.tar.bz2'\" 1&gt;&amp;2\nfi\n</code></pre> </li>\n<li><p> Jadikan itu dapat dieksekusi: </p>\n\n<p> <code>chmod a+x tarrm</code> </p></li>\n</ol>\n\n<p> Skrip melakukan beberapa pemeriksaan kesalahan dasar: <code>dir1</code> harus ada, <code>$ ls /tmp/mnt\ndir1.tar.bz2  lost+found\n</code> dan <code>dir1.tar</code> seharusnya tidak ada dan memiliki <em> menjaga </em> mode. Ini juga mendukung direktori dan nama file dengan spasi yang disematkan. </p>\n\n<p><strong> Saya telah menguji skripnya tetapi tidak dapat menjamin bahwa itu sempurna </strong> , jadi gunakan dulu dalam mode simpan: </p>\n\n<p> <code>./tarrm dir1 --keep</code> </p>\n\n<p> Pemanggilan ini akan menambahkan <code>dir1</code> ke <code>dir1.tar.bz2</code> tetapi tidak akan menghapus direktori. </p>\n\n<p> Ketika Anda mempercayai skrip, gunakan seperti ini: </p>\n\n<p> <code>./tarrm dir1</code> </p>\n\n<p> Skrip akan memberi tahu Anda bahwa <code>find dir1 -depth -print0</code> akan dihapus dalam proses memasang tar: </p>\n\n<p> <code>Tarring and **deleting** 'dir1'</code> </p>\n\n<p> Sebagai contoh: </p> <pre><code>$ ls -lF\ntotal 4\ndrwxrwxr-x 3 jaume jaume 4096 2013-10-11 11:00 dir 1/\n$ find \"dir 1\"\ndir 1\ndir 1/subdir 1\ndir 1/subdir 1/file 1\ndir 1/file 1\n$ /tmp/tarrm dir\\ 1/\n Tarring and **deleting** 'dir 1/'\n$ echo $?\n0\n$ ls -lF\ntotal 4\n-rw-rw-r-- 1 jaume jaume 181 2013-10-11 11:00 dir 1.tar.bz2\n$ tar --list --file dir\\ 1.tar.bz2 \ndir 1/subdir 1/file 1\ndir 1/subdir 1/\ndir 1/file 1\ndir 1/\n</code></pre>","votes":"8","source":"https://superuser.com/a/657440","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">jaume</span></a>","replies":[{"reply":"Pendekatan yang menarik. Tampaknya tergantung pada ketersediaan ruang disk yang cukup untuk menyimpan arsip tar yang tidak terkompresi serta arsip yang hampir terkompresi sepenuhnya, karena bzip2 (serta alat lain yang saya ketahui) sebenarnya tidak kompres <i> di tempat </i> . Mungkin, mungkin saja, Anda bisa menggunakan pipa dari subkulit untuk membantu itu?","author":"<a href=\"https://superuser.com/users/53590/user\" target=\"_blank\" rel=\"nofollow noopener\">user</a>"},{"reply":"Ya, solusi yang saya usulkan memang membutuhkan cukup ruang untuk mengompresi <code>dir1.tar</code>. Pendekatan lain (yang lebih sederhana) adalah menggunakan <code>zip</code> sebagai gantinya: <code>zip --recurse-paths --move &quot;dir 1.zip&quot; &quot;dir 1&quot;</code>. Saya telah mengedit jawaban saya dengan menyebutkan <code>zip</code> ...","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"Nah, ternyata <code>zip</code> bukanlah pilihan. Saya memutar kembali ke jawaban awal. <code>zip</code> tidak memberikan apa yang diinginkan OP (dari halaman manual): <i> --move Pindahkan file yang ditentukan ke dalam arsip zip; sebenarnya, ini menghapus direktori / file target <b> setelah membuat </b> arsip zip tertentu. Jika direktori menjadi kosong setelah file dihapus, direktori tersebut juga dihapus. <b> Tidak ada penghapusan yang dilakukan sampai zip membuat arsip tanpa kesalahan. </b></i> &lt;/b&gt;","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"Solusi yang mengesankan. Saya kira pertanyaan yang tersisa adalah berapa banyak ruang kosong yang diperlukan untuk menjalankan operasi ini. Apakah itu memerlukan arsip + arsip asli, atau lebih kecil dari itu?","author":"<a href=\"https://superuser.com/users/225838/gregg-leventhal\" target=\"_blank\" rel=\"nofollow noopener\">Gregg Leventhal</a>"},{"reply":"@ MichaelKjörling Terima kasih atas petunjuknya, saya perhatikan saya dapat menggunakan <code>tar --create</code> daripada <code>tar --append</code> jadi saya meningkatkan solusi untuk menyalurkan dan mengirim output terkompresi ke file. Sekarang jumlah ruang disk kosong yang dibutuhkan adalah ukuran file yang dikompresi di <code>dir1</code> yang merupakan yang terbesar setelah dikompresi, jauh lebih kecil dari <code>dir.tar</code>.","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"@GreggLeventhal Saya telah meningkatkan solusinya dan sekarang jumlah ruang disk kosong yang diperlukan adalah ukuran file yang dikompresi pada <code>dir1</code> yang merupakan yang terbesar setelah dikompresi. Saya melakukan pengujian dengan sistem file 98% penuh dan bekerja tanpa hambatan.","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"Saya belum mengujinya sendiri, tetapi saya memberi Anda jawaban atas jumlah waktu dan upaya yang Anda lakukan. Anda harus menempatkan skrip ini ke bahasa tingkat yang lebih tinggi seperti Python dan membuka sumbernya. Terima kasih atas pekerjaan Anda!","author":"<a href=\"https://superuser.com/users/225838/gregg-leventhal\" target=\"_blank\" rel=\"nofollow noopener\">Gregg Leventhal</a>"},{"reply":"Saya sangat menghargai komentar Anda, Gregg. Python saya (dan PHP, Perl, dll dalam hal ini) sangat buruk jadi saya tidak berpikir saya akan menulis ulang skrip tetapi saya telah menambahkan pernyataan izin penyalinan GPL standar. Pastikan Anda memiliki cadangan data Anda sebelum menguji skrip.","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"Saya akan memberikan suara positif ini lagi jika saya bisa, tetapi sayangnya, saya sudah menggunakan penjatahan suara positif saya untuk jawaban khusus ini ...","author":"<a href=\"https://superuser.com/users/53590/user\" target=\"_blank\" rel=\"nofollow noopener\">user</a>"},{"reply":"Saya pikir ada sesuatu yang hilang di sini. variabel &quot;removeir&quot; tidak digunakan, dan saat diuji, program ini hanya menghapus file tetapi tidak direktori. Saya hanya akan menambahkan <code>if [ &quot;$removedir&quot; == &quot;true&quot; ]; then;rm -rf $dir; fi</code>","author":"<a href=\"https://superuser.com/users/239282/mveroone\" target=\"_blank\" rel=\"nofollow noopener\">mveroone</a>"},{"reply":"Anda benar, terima kasih telah menunjukkannya dan atas saran Anda. Saya akan memeriksa skripnya nanti dan mengeditnya.","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"@Kwaio Dalam pengujian saya, saya menemukan bahwa variabel <code>removedir</code> tidak diperlukan, jadi saya telah menghapusnya. Direktori akan dihapus jika <code>--keep</code> tidak ditentukan, saya bertanya-tanya mengapa hanya menghapus file dalam pengujian Anda. Saya menjalankan <code>tarrm</code> di OS X 10.9.1.","author":"<a href=\"https://superuser.com/users/156041/jaume\" target=\"_blank\" rel=\"nofollow noopener\">jaume</a>"},{"reply":"Saya menggunakan RHEL3 dengan kernel 2.4.17 dan coreutils 4.5.3. yang dapat mengubah banyak hal. Terima kasih untuk skripnya, bagaimanapun, file adalah yang paling memakan ruang.","author":"<a href=\"https://superuser.com/users/239282/mveroone\" target=\"_blank\" rel=\"nofollow noopener\">mveroone</a>"}]}]}
