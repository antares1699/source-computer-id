{"title":"Koneksi OpenVPN melalui terowongan SSH","draft":false,"url":"/koneksi-openvpn-melalui-terowongan-ssh-xzrt92xe","votes":"4","answers_count":"4","categories":["Komputer"],"tags":["networking","ssh","vpn","openvpn","iptables"],"snippet":"Saat ini saya mengunjungi China, jadi saya memiliki beberapa opsi untuk penyiapan VPN. Namun, server VPN saya memiliki kebiasaan tiba-tiba menghilang dari jaringan setelah saya menggunakannya untuk beberapa saat.  Saya pikir ini...","body":"<p> Saat ini saya mengunjungi China, jadi saya memiliki beberapa opsi untuk penyiapan VPN. Namun, server VPN saya memiliki kebiasaan tiba-tiba menghilang dari jaringan setelah saya menggunakannya untuk beberapa saat. </p>\n\n<p> Saya pikir ini mungkin opsi untuk menggunakan terowongan SSH ke server lain, dan menghubungkan VPN melalui itu, untuk mencegah lalu lintas VPN terdeteksi. Dengan begitu, kemungkinan lalu lintas hanya terbaca sebagai koneksi SSH ke penyedia. </p>\n\n<p> Jadi, saya terhubung ke server seperti ini: </p> <pre><code>ssh peter@some-server -L 4444:vpn-server:1194 -N\n</code></pre> <p> Dan kemudian tambahkan ini ke konfigurasi klien openvpn saya: </p> <pre><code>remote localhost 1194\n</code></pre> <p> Sayangnya, ini tidak berhasil. Sambungan diautentikasi, tetapi setelah itu, saya tidak dapat terhubung ke bagian dalam VPN (<code>ping 10.8.0.1</code>) atau luar (<code>ping 8.8.8.8</code>). Haruskah ini berhasil, atau apakah saya salah paham? </p>\n\n<p> Apakah ada beberapa aturan nat iptables yang harus saya tambahkan? Satu-satunya aturan nat yang saya tambahkan sejauh ini adalah: </p> <pre><code>-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE\n</code></pre>","source":"https://superuser.com/questions/1356330/openvpn-connection-through-ssh-tunnel","author":"<a href=\"https://superuser.com/users/368253/peter\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">Peter</span></a>","replies":[{"reply":"Server VPN menghilang karena server Pemerintah Cina mengidentifikasi bahwa Anda menggunakan VPN. Pertanyaannya, apakah Anda BENAR-BENAR membutuhkan VPN ini? Terlepas dari tantangan teknis, adakah alasan yang cukup untuk melakukan sesuatu yang bisa ilegal? Jika mereka melacak penggunaan VPN Anda dan sampai kepada Anda, mereka dapat menahan Anda karena menggunakan VPN. China bukanlah negara asing tempat Anda ingin ditangkap. Mereka bisa memenjarakan Anda selama berbulan-bulan hampir tanpa bayaran. Apakah itu layak?","author":"<a href=\"https://superuser.com/users/913277/mguima\" target=\"_blank\" rel=\"nofollow noopener\">mguima</a>"},{"reply":"@mguima Saya rasa Anda telah melihat terlalu banyak film.","author":"<a href=\"https://superuser.com/users/368253/peter\" target=\"_blank\" rel=\"nofollow noopener\">Peter</a>"},{"reply":"Mungkin. Ingat, mereka bukan orang Barat. Ini menghubungkan dunia lain.","author":"<a href=\"https://superuser.com/users/913277/mguima\" target=\"_blank\" rel=\"nofollow noopener\">mguima</a>"}],"answers":[{"answer":"<p> Pendekatan sederhana untuk menyiapkan koneksi VPN Anda melalui terowongan SSH tidak akan berfungsi. Masalah pertama: Anda hanya melakukan tunneling koneksi ke server VPN itu sendiri, yang kemudian tidak mengizinkan semua lalu lintas lain untuk dirutekan melalui server VPN <strong> LEBIH </strong> koneksi <code>ssh</code> (sehingga mengaburkan koneksi). Perbaikan untuk ini adalah dengan menggunakan proxy SOCKS [5] dinamis dan memberi tahu OpenVPN untuk terhubung melalui proxy itu. Tambahkan ke file konfigurasi OpenVPN Anda: </p> <pre><code>socks-proxy localhost 6886\nsocks-proxy-retry\n</code></pre> <p> Kemudian, mulai sesi <code>ssh</code> Anda dengan proxy SOCKS dinamis: </p> <pre><code>ssh -D 6886 -N REMOTE\n</code></pre> <p> Kemudian Anda dapat memulai koneksi OpenVPN Anda. Namun, ini masih memiliki satu kegagalan lagi, setidaknya dengan asumsi Anda ingin mengalihkan <strong> semua lalu lintas </strong> melalui VPN (OpenVPN directive <code>redirect-gateway def1</code>). Agar berfungsi, Anda perlu mempertahankan rute ke titik akhir proxy SOCKS yang tidak ditutupi oleh rute yang ditambahkan oleh klien OpenVPN. Untuk melakukan ini, tambahkan arahan lain ke konfigurasi OpenVPN Anda yang terlihat seperti ini: </p> <pre><code>route REMOTE-IP 255.255.255.255 net_gateway default\n</code></pre> <p> Kamu <strong> mungkin </strong> dapat menggunakan nama host REMOTE dalam arahan itu, tetapi Anda mungkin perlu mengatasinya ke alamat IP secara manual. </p>\n\n<p> Itu harus bekerja, setidaknya untuk lalu lintas ipv4. Pencarian google cepat muncul <a href=\"https://kiljan.org/2017/11/15/routing-traffic-through-openvpn-using-a-local-socks-proxy/\" rel=\"nofollow noopener\" target=\"_blank\"> posting blog ini </a> yang pada dasarnya melakukan hal yang sama, memiliki deskripsi yang baik tentang apa yang terjadi, tetapi tampaknya lebih rumit dalam solusi (menggunakan skrip koneksi) </p>\n\n<p> Atau, Anda mungkin juga melihat menggunakan <code>obfs4proxy</code> (mis. <a href=\"https://trac.torproject.org/projects/tor/wiki/doc/PluggableTransports/obfs4proxy\" rel=\"nofollow noopener\" target=\"_blank\"> ini </a> dan <a href=\"https://github.com/Yawning/obfs4\" rel=\"nofollow noopener\" target=\"_blank\"> ini </a> atau <a href=\"http://manpages.ubuntu.com/manpages/xenial/man1/obfs4proxy.1.html\" rel=\"nofollow noopener\" target=\"_blank\"> dikemas untuk ubuntu </a> ) </p>","votes":"4","source":"https://superuser.com/a/1356991","author":"<a href=\"https://superuser.com/users/367026/crimson-egret\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">crimson-egret</span></a>","replies":[]},{"answer":"<p> Terowongan SSH dengan VPN berfungsi di Cina, meskipun sangat lambat. Menurunkan pengaturan enkripsi tidak akan meningkatkan kecepatan. Saya pikir kecepatan koneksi umumnya dibatasi dari China ke bagian mana pun di dunia. </p>\n\n<p> Bagaimana saya melakukannya adalah terowongan SSH dengan penerusan port yang diaktifkan. Dan kemudian gunakan OpenVPN dengan SOCKS Proxy melalui terowongan SSH itu. Nomor port non-default juga berfungsi. </p>\n\n<p> Tidak perlu firewall atau konfigurasi rute. Bekerja dengan baik untuk saya. :) </p>","votes":"3","source":"https://superuser.com/a/1518507","author":"<a href=\"https://superuser.com/users/1131450/overseas-chinese\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">overseas.chinese</span></a>","replies":[]},{"answer":"<p> Saya berhasil membuat koneksi ke Raspberry Pi saya (dengan PiVPN)\nmelalui TCP dan VPS eksternal. Lalu saya melakukan ini: </p>\n\n<p> izinkan penerusan ke publik di server Anda (VPS / VPN). Ubah <code>GatewayPorts</code> menjadi <code>yes</code> atau tambahkan jika belum ada. </p> <pre><code>/etc/ssh/sshd_config:\nGatewayPorts yes\n</code></pre> <p> Ubah <code>proto udp</code> menjadi <code>tcp</code> (karena ssh menggunakan protokol tcp) </p> <pre><code>/etc/openvpn/server.conf:\nproto tcp\n</code></pre> <p> Sekali lagi, ubah <code>proto udp</code> menjadi <code>tcp-client</code>: </p> <pre><code>openvpn-client.ovpn:\nproto tcp-client\n</code></pre> <p> Sekarang mulai ssh forwarding\n(0.0.0.0 untuk mengizinkan semua koneksi IPv4; -N untuk tidak memulai bash di server) </p> <pre><code>ssh -R 0.0.0.0:1194:localhost:1194 user@server -N\n</code></pre> <p> Anda juga harus memeriksa apakah server VPS / VPN Anda memungkinkan koneksi dan memiliki pengaturan firewall yang benar. Jika Anda menggunakan ufw untuk iptables, cukup lakukan ini: </p> <pre><code>ufw allow 1194/tcp\nufw enable\n</code></pre> <p> Ini mungkin bukan yang tercepat tapi berhasil untuk saya. </p>","votes":"1","source":"https://superuser.com/a/1418581","author":"<a href=\"https://superuser.com/users/947906/bostrot\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">Bostrot</span></a>","replies":[]},{"answer":"<p> Anda tidak perlu menjalankan VPN lain <em> melalui </em> ssh. Anda dapat menggunakan ssh <em> SEBAGAI </em> VPN. lihat opsi &quot;-w X: Y&quot; ssh. </p>\n<p> Ini adalah jawaban yang berpusat pada linux. Asumsikan server, kita akan menyebutnya &quot;hub&quot;, yang terhubung dengan klien terowongan ssh. Mereka akan menggunakan 172.17.2.0/24 sebagai jaringan &quot;operator&quot; VPN. Beberapa host umum dan terkenal, kami memberi mereka konfigurasi tetap. Orang lain juga dapat terhubung tetapi harus menggunakan konfigurasi lain. </p> <pre><code>#!/bin/sh -e\n#\n# make-ssh-tunnel HITHER YON INTERFACE GW\n#\n# HITHER ...... this host's VPN address.\n# YON ......... $GW's VPN address.\n# INTERFACE ... number of the tun device, same at both ends.\n# GW .......... server host.\n#\n# /etc/ssh/sshd_config on $GW must include:\n#   PermitRootLogin yes\n#   PermitTunnel yes\n# and clients must be able to ssh to $GW as root.\n#\n# this creates a star topology with $GW at center,\n# which is generally the .1 address in the VPN /24 net.\n# others connect and route through $GW to reach\n# the other members of the /24 net.\n# ________________________________________________\n#\n# the setup.\n#\nif [ &quot;$#&quot; = 0 ] ; then\n    # automatic, for specific, known, regularly-connected hosts.\n    case &quot;`hostname -s`&quot; in\n    ThisHost) HITHER=172.17.2.2 IFACE=12 ;;\n    ThatHost) HITHER=172.17.2.3 IFACE=13 ;;\n    Another)  HITHER=172.17.2.4 IFACE=14 ;;\n    *)        echo who are you? ; exit 1 ;;\n    esac\n    YON=172.17.2.1\n    GW=hub\n    SUBNET=172.17.2.0\nelse\n    # manual, for random, probably temporary connections.\n    HITHER=&quot;${1:-172.17.2.5}&quot;\n    YON=&quot;${2:-172.17.2.1}&quot;\n    IFACE=&quot;${3:-15}&quot;\n    GW=&quot;${4:-hub}&quot;\n    SUBNET=&quot;${YON%.[0-9]*}&quot;.0\n    #\n    [ &quot;$HITHER&quot; = &quot;$YON&quot; ] &amp;&amp; echo &quot;${0##*/}&quot;: identical addresses not allowed &amp;&amp; exit 1\nfi\n#\n# the business.\n#\nset -x\n# 1st: do it there.\nssh -f -T -w $IFACE:$IFACE root@$GW \\\n&quot;ifconfig tun$IFACE $YON pointopoint $HITHER netmask 255.255.255.255\n ifconfig tun$IFACE\n route -n | grep tun$IFACE&quot;\n# 2nd: do it here.\n ifconfig tun$IFACE $HITHER pointopoint $YON netmask 255.255.255.255\n ifconfig tun$IFACE\n route add -net $SUBNET/24 gw $YON\n route -n | grep tun$IFACE\n#\n# the afterthought.\n#\n# to make the tunnel a default route replacement:\n#\n# route add -host $GW gw 192.168.0.1 # that is, your real.defa.ult.route\n# ip route add   0.0.0.0/1 via $YON\n# ip route add 128.0.0.0/1 via $YON\n#\n# 1st preserves real route to $GW, avoiding route loop.\n# 2nd and 3rd override default route without replacing it.\n#\n# in addition, $GW must NAT on behalf of the VPN hosts.\n# iptables -t nat -A POSTROUTING -s 172.17.2.0/24 -o eth0 -j SNAT --to-source 11.22.33.44\n# where --to-source is $GW's real external address.\n#\n# Embellish to taste.\n</code></pre>","votes":"1","source":"https://superuser.com/a/1616347","author":"<a href=\"https://superuser.com/users/1260401/karl\" target=\"_blank\" rel=\"nofollow noopener\"><span itemprop=\"name\">karl</span></a>","replies":[{"reply":"Jawaban yang bagus memang, tapi tolong jelaskan apa yang dilakukan setiap baris kode selain memberi komentar di kode.","author":"<a href=\"https://superuser.com/users/1250181/xe%d0%bd%ce%b5i-%ce%9e%d1%8dn%d0%b2%cf%b5%cf%82\" target=\"_blank\" rel=\"nofollow noopener\">Xe&#x43D;&#x3B5;i &#x39E;&#x44D;n&#x432;&#x3F5;&#x3C2;</a>"}]}]}
